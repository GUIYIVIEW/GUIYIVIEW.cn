---
title: iOSæ‰“åŒ… fastlaneå¤šä¸ªtargetåŒæ—¶æ‰“åŒ…
date: 2022-11-04 15:31:54
tags:
- iOS
- fastlane
- æ‰“åŒ…
categories:
- iOS
- æ‰“åŒ…
---

### å‰è¨€
çªç„¶æ¥æ‰‹äº†ä¸€ä¸ªè®¸ä¹…æœªæ›¾æ›´æ–°çš„é¡¹ç›®ï¼Œé¡¹ç›®ä¸­å‡ ä¹å…¨å›½æ¯ä¸ªåŸå¸‚éƒ½å»ºäº†ä¸€ä¸ª`target`ï¼Œè€Œæ‰‹åŠ¨æ‰“åŒ…çš„è¯éœ€è¦å¾ˆå¤§çš„è€å¿ƒï¼Œä¸”æµªè´¹éå¸¸å¤šçš„æ—¶é—´ã€‚é‰´äºæ­¤ï¼Œåœ¨ç½‘ä¸Šæœç´¢äº†å¦‚ä½•ä½¿ç”¨å¤š`target`æ‰“åŒ…ï¼Œ[è¿™ç¯‡æ–‡ç« è®²è§£çš„å¾ˆè¯¦ç»†](https://www.jianshu.com/p/2893994e573b)ï¼Œä½†æ˜¯æ¶‰åŠçš„å…¶å®ƒå†…å®¹å¤ªå¤šï¼Œç ”ç©¶è¿™äº›å†…å®¹ä¹Ÿæœ‰ç‚¹è´¹åŠ›ã€‚äºæ˜¯è‡ªå·±å°±ç¼–å†™æµ‹è¯•ã€è¾¹æ”¹è¾¹æµ‹ï¼Œç»ˆäºèŠ±è´¹äº†ä¸€ä¸ªå¤šå°æ—¶ï¼ŒæˆåŠŸå®ç°äº†ä¸€ä¸ªå‚»ç“œå¼æ•™ç¨‹`T_T`.

### ç¬¬ä¸€æ­¥
ç¼–å†™`Fastfile`æ–‡ä»¶ï¼Œå…³äº`fastlane`çš„å®‰è£…å°±ä¸ä½œå™è¿°ã€‚
```
default_platform(:ios)

HOME_PATH = ENV["HOME"] #home è·¯å¾„ å–ç³»ç»Ÿç¯å¢ƒå˜é‡ HOME
IPA_BASE_PATH = "#{HOME_PATH}/Desktop/IPA/" # ipaåŸºç¡€è·¯å¾„
FIR_IM_API_TOKEN = "å¡«å†™fir token" #fir.im api_token

def archive(schemeName, verStr, method)

    verArray = verStr.split(".")
        build = verArray.pop()
        version = verArray.join(".")

    if !schemeName
        notification(subtitle: "å‚æ•°é”™è¯¯", message: "é”™è¯¯ä¿¡æ¯ï¼šè¯·è¾“å…¥ schemeName")
        return
    end

    if !version
        notification(subtitle:"å‚æ•°é”™è¯¯", message: "é”™è¯¯ä¿¡æ¯ï¼šè¯·è¾“å…¥ version")
        return
    end
    
    if !build
        notification(subtitle: "å‚æ•°é”™è¯¯", message: "é”™è¯¯ä¿¡æ¯ï¼šè¯·è¾“å…¥ build")
        return
    end

    puts "å¼€å§‹æ‰“åŒ… #{schemeName} #{verStr}"

    floderName = "v" + version + "Build" + build
    if method == "ad-hoc"
        dir_name = "AdHoc"
    elsif method == "app-store"
        dir_name = "AppStore"
    elsif method == "development"
        dir_name = "Develop"
    else
        dir_name = "unknown"
    end
    time = Time.new.strftime("%Y%m%d_%H%M")
    output_directory = "#{IPA_BASE_PATH}/#{schemeName}_#{time}/" + floderName + "/" + dir_name
    #ç¼–è¯‘ ipa
    gym(
        # æŒ‡å®šschemeåå­—
        scheme: "#{schemeName}",
        # è¾“å‡ºçš„ipaåç§°
        output_name: "#{schemeName}",
        # æ˜¯å¦æ¸…ç©ºä»¥å‰çš„ç¼–è¯‘ä¿¡æ¯ trueæ˜¯
        clean: true,
        # æŒ‡å®šè¾“å‡ºæ–‡ä»¶å¤¹ï¼Œè¿™é‡Œä¼šä¿å­˜æˆ‘ä»¬æœ€åç”Ÿæˆçš„ipaæ–‡ä»¶
        output_directory: output_directory,
        # æŒ‡å®šæ‰“åŒ…æ‰€ä½¿ç”¨çš„çš„è¾“å‡ºæ–¹å¼ï¼Œç›®å‰æ”¯æŒ app-store, package, ad-hoc, enterprise, development
        export_method: method
        )
    return output_directory
end

def eachArchive(options, method, upload)
    string = options[:v]

    tmpArray = string.split("+")
    puts "====: #{options}ï¼Œ #{tmpArray}"
    for tmp in tmpArray do 
        array = tmp.split("_")
        verStr = array.pop()
        name = array.first()
        output_directory = archive(name, verStr, method)
        if !output_directory
            next
        end

        if upload != true
            next
        end
        # ä¸Šä¼ fir
        fir_im_upload_path = output_directory + "/#{name}.ipa"
        puts "ä¸Šä¼ FIR è·¯å¾„ä¸ºï¼š" + fir_im_upload_path
        sh("fir publish #{fir_im_upload_path} -T #{FIR_IM_API_TOKEN}")
        result_message = "å†…æµ‹ç‰ˆæœ¬ #{name}.ipa ç‰ˆæœ¬å·" + verStr + "ä¸Šä¼  fir.im æˆåŠŸ"
        notification(subtitle:"ğŸ‰ğŸ‰ #{method} æ“ä½œæˆåŠŸ", message:"#{result_message}")
        sh("say #{result_message}")
    end
end

platform :ios do
  desc "Description of what the lane does"
  lane :adhoc do |options|
      eachArchive(options, "ad-hoc", true)
  end

  lane :reipa do |options|
      eachArchive(options, "app-store", false)
  end
end

```
### ç¬¬äºŒæ­¥
å› ä¸ºæ˜¯å‚»ç“œå¼æ•™ç¨‹ï¼Œå¿…ç„¶è¿˜æ˜¯æœ‰äº›æ‰‹åŠ¨å·¥ç¨‹æ“ä½œçš„ï¼Œé‚£å°±æ˜¯åœ¨æ‰“ä¸åŒç±»å‹çš„åŒ…æ—¶ï¼Œéœ€è¦æ‰‹åŠ¨åœ¨å·¥ç¨‹ä¸­æ”¹å˜æè¿°æ–‡ä»¶çš„é€‰æ‹©ï¼Œæ¯”å¦‚æ‰“`Adhoc`åŒ…ï¼Œå°±éœ€è¦åœ¨å·¥ç¨‹ä¸­é€‰æ‹©`Adhoc`çš„æè¿°æ–‡ä»¶ï¼Œå…¶å®ƒäº¦å¦‚æ˜¯ã€‚

### ç¬¬ä¸‰æ­¥
ç”¨æ³•
å•ä¸ª`target`ä½¿ç”¨ `fastlane adhoc v:TestOne_1.2.3.45`
å¤šä¸ª`target`ä½¿ç”¨ `fastlane adhoc v:TestOne_1.2.3.45+TestTwo_1.2.34`
æ€»ä¹‹å°±æ˜¯æ ¹æ®è‡ªå·±éœ€è¦æ‰“å“ªäº›`target`ï¼Œå°±åœ¨åé¢æ‹¼ä¸Šå¯¹åº”çš„æ ¼å¼ï¼Œè¿™è¿˜çœŸæ˜¯ä¸€çœ‹å°±ä¼šçš„å‚»ç“œå¼æ–¹å¼ã€‚
`+_.`è¿™äº›ç¬¦å·éƒ½æ˜¯ä¸ºäº†æ–¹ä¾¿åŒºåˆ†çš„ï¼Œå½“ç„¶ï¼Œè¿™ä¸ªæ ¼å¼æ˜¯å¯ä»¥è‡ªå·±æ‰‹åŠ¨æ”¹çš„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨`Fastfile`æ–‡ä»¶ä¸­å®šä¹‰ä¸€ä¸ªæ•°ç»„ï¼Œè€Œä¸ç”¨åœ¨å‘½ä»¤è¡Œæ¯æ¬¡éƒ½æ‰‹åŠ¨æ‹¼ã€‚

### é”™è¯¯
`xcodebuild: error: The workspace named "CITY" does not contain a scheme named "CITY". The "-list" option can be used to find the names of the schemes in the workspace.`
è§£å†³æ–¹æ¡ˆæ˜¯æŠŠå·¥ç¨‹ä¸­`scheme`å¯¹åº”çš„`project`æ”¹ä¸ºå¯¹åº”çš„`Workspace`ï¼Œå¦‚æœä¸æ˜¯`Workspace`å·¥ç¨‹çš„ä¸å¿…ç†ä¼šè¿™ä¸€æ­¥ã€‚
![QQ20211209-101443.png](/images/20221104/1094796-61e4424d6680b0dd.png)

### ç»“å°¾
ç›®å‰æ²¡æœ‰å‘ç°å…¶å®ƒé”™è¯¯ä¿¡æ¯ï¼Œè™½ç„¶æ˜¯å‚»ç“œå¼çš„æ–¹å¼ï¼Œä¸è¿‡ä¹ŸèŠ‚çº¦äº†ä¸å°‘æ—¶é—´ï¼Œè€Œä¸”é…ç½®ç®€å•ï¼Œä¸€çœ‹å°±æ‡‚ã€‚ç¼ºç‚¹å°±æ˜¯å¦‚æœæ‹¼æ¥æ ¼å¼ä¸­é—´æœ‰é”™è¯¯ï¼Œå°±ä¼šä»é”™è¯¯çš„`target`åœæ­¢ï¼Œä½†æ˜¯å‰é¢å·²ç»æ‰“åŒ…å¥½çš„æ˜¯ä¸å—å½±å“ï¼Œå¯ä»¥ä»é”™è¯¯çš„ä½ç½®å†æ¬¡æ‹¼æ¥åæ‰§è¡Œã€‚

å¦‚æœä½ æœ‰æ–¹ä¾¿çš„æ–¹æ³•å¯ä»¥å»é™¤æ‰‹åŠ¨æ›´æ–°æè¿°æ–‡ä»¶è¿™ä¸€æ­¥ï¼Œæ•¬è¯·ç•™è¨€ğŸ¤—

